carol-the-bells — README

## Краткое содержание

Это репозиторий с одним самодостаточным SVG-файлом `carol-the-bells.svg`, который визуализирует схему хора и реализует фазу хореографии Stage 1 — движение сопрано и альтов в центральной области сцены.

README служит двухцелевой задаче:
- подробно фиксирует исходное техническое задание (включая изначальную формулировку задачи),
- даёт компактную и расширяемую структуру для добавления следующих стадий хореографии, параметров и правил поведения, на основании которой можно заново (или программно) воссоздать / править SVG.

## Исходный (начальный) prompt

Ниже — исходное задание (скопировано из начального запроса). Это важная спецификация, она должна сохраняться как источник правды при изменениях.

"Ты — опытный фронтенд-разработчик, умеющий писать чистые SVG c встраиваемым JavaScript (без внешних библиотек).  
Нужно сгенерировать ОДИН самодостаточный SVG-файл, который:

1) рисует статическую схему хора на сцене;
2) поэтапно анимирует движение части хористов согласно описанным стадиям хореографии.

Важна не «физика», а визуально правдоподобное, аккуратное движение: без телепортаций, без пересечений фигур и с понятным направлением взгляда.

========================================
ОБЩИЕ ТРЕБОВАНИЯ
========================================

1. Сцена:
   - Размер: сцена 16:9, например viewBox 0 0 1600 900.
   - Фон: тёмный прямоугольник + светлая рамка.
   - Вверху по центру подпись: «К зрителю (передний край сцены)» — верх картинки это фронт сцены.

2. Певцы:
   - Каждый певец — горизонтальный овал с соотношением сторон 2:1 (например rx=40, ry=20).
   - Цвета партий:
     - сопрано — жёлтый,
     - альты — оранжевый,
     - тенора — зелёный,
     - баритоны — синий,
     - солист — красный, чуть крупнее.
   - У каждого овала есть короткая, достаточно толстая стрелка-направление:
     - начинается из центра овала,
     - немного выходит вперёд за контур,
     - поворачивается вместе с овалом и показывает направление взгляда/движения.

3. Количество и партии:
   - сопрано: 10 человек, ДВИГАЮТСЯ в анимации;
   - альты: 10 человек, ДВИГАЮТСЯ в анимации;
   - тенора: 8 человек, стоят, НЕ двигаются (статичные препятствия);
   - баритоны: 8 человек, стоят, НЕ двигаются (статичные препятствия);
   - 1 солист: красный, по центру, НЕ двигается.

4. Исходная расстановка:
   - Две симметричные вертикальные колонны слева и справа.
   - В каждой колонне — 9 рядов по вертикали, в каждом ряду по 2 человека (левый и правый столбец).
   - Левая колонна:
     - верхние 5 рядов (ближе к зрителю) — альты (10 подвижных),
     - нижние 4 ряда — баритоны (8 статичных).
   - Правая колонна:
     - верхние 5 рядов — сопрано (10 подвижных),
     - нижние 4 ряда — тенора (8 статичных).
   - Колонны:
     - стоят близко к левому и правому краям сцены,
     - и относительно близко друг к другу, чтобы между ними оставалось большое, но не «пустое» поле.
   - Солист:
     - один красный овал чуть крупнее,
     - стоит по центру сцены ближе к переднему краю,
     - под ним текст «Солист».

5. Расстояния между овалами (БЕЗ пересечений):
   - Пусть ширина овала W (например, 80), высота H (например, 40).
   - Вертикальный шаг между рядами по центрам:
     H + (2/3)·W.
   - Горизонтальный шаг между двумя певцами в одном ряду по центрам:
     W + (2/3)·W.
   - В исходной расстановке овалы НЕ должны пересекаться ни по горизонтали, ни по вертикали.

6. Техника реализации (кратко):
   - Внутри SVG один `<script>` с чистым JS, без внешних библиотек.
   - Все певцы создаются ПРОЦЕДУРНО в JS через одну универсальную функцию `createSinger(...)`  
     (никакого ручного копипаста десятков `<g>` в разметке).
   - Для каждого певца храни:
     - роль (soprano/alto/tenor/baritone/soloist),
     - флаг подвижности,
     - исходные координаты центра,
     - текущий угол поворота (для стрелки),
     - для подвижных — текущую цель движения.

========================================
ОБЩИЕ ПРАВИЛА АНИМАЦИИ
========================================

Эти правила должны соблюдаться на всех стадиях:

1. Кто двигается:
   - Двигаются только сопрано и альты.
   - Баритоны, тенора и солист остаются на месте и играют роль препятствий.

2. Начало движения:
   - Фаза 1 и любая следующая фаза могут начинаться не раньше чем через 1 секунду от начала SVG (например, movementStart = 1000 мс).
   - ДО начала движения:
     - нельзя менять координаты и transform у подвижных фигур,
     - статичная картинка и первое положение в анимации должны совпадать пиксель-в-пиксель,
     - категорически недопустим «рывок" / скачок / gap в момент старта.

3. Движение:
   - Подвижные певцы ходят по центральной области между колоннами:
     - по X: внутри промежутка между левыми и правыми колоннами (без влезания в сами колонны),
     - по Y: от верхних рядов до нижних, но не выходя за сцену.
   - Траектории:
     - не только вверх-вниз, но и по диагонали,
     - певцы регулярно меняют направление — не должны всё время идти по одной прямой.
     - разумная схема: у каждого есть «цель» (targetX, targetY), он идёт к ней, потом получает новую цель (через достижение цели или по таймауту).

4. Поворот корпуса:
   - Направление стрелки и овала должно соответствовать направлению движения/взгляда.
   - При смене направления угол должен меняться плавно, с ограниченной скоростью поворота (без мгновенного разворота на 180° за один кадр).

5. Столкновения и пересечения:
   - В анимации подвижные фигуры НЕ должны:
     - проходить сквозь статичных (баритоны, тенора, солист),
     - проходить сквозь других подвижных.
   - Разрешён «алгоритмический" подход:
     - избегание препятствий при планировании следующего шага,
     - отталкивание при сильном сближении,
     - переназначение целей, если двое «упёрлись" друг в друга.
   - Важно: зритель никогда не должен видеть пересечения эллипсов.

========================================
СТАДИИ ХОРЕОГРАФИИ
========================================

Ниже я буду описывать хореографию ПООЧЕРЁДНО по стадиям.  
Каждая стадия:
- имеет номер и примерную длительность,
- описывает, кто и как двигается в этот период,
- начинается после окончания предыдущей стадии (или с указанной временной метки).

Сделай код так, чтобы можно было легко:
- добавить новую стадию,
- сменить цели движения или поведение групп в зависимости от текущей стадии.

Итак, реализуйте Stage 1 (описание далее).

---

## Дополнения и уточнения, внесённые в процессе разработки

В процессе разработки и при обсуждении были внесены следующие уточнения и улучшения к поведению и реализации (они важны и включены в текущую версию `carol-the-bells.svg`):

- В каждой колонне должно быть по 2 человека в ряду (то есть по 18 человек в каждой колонне — но по ролям это даёт требуемые 10/8 на каждой стороне: верхние 5 рядов подвижные, нижние 4 статичные).
- Стрелки должны быть белого цвета и изначально смотреть к зрителю (вверх по экрану), и быть короткими — только немного выходить за край овала.
- Подвижные артисты (сопрано и альты) не должны телепортироваться при старте: они обязаны начать движение именно из своей начальной позиции. Для этого реализовано поведение плавного включения анимации без рывков.
- Движение реализовано через векторную модель (у каждого мобильного — текущее vx, vy), с плавным сглаживанием поворота (steering), демпфированием и ограничением угловой скорости.
- Избегание столкновений — двухступенчатое:
  1. Прогнозирование: если предсказывается пересечение, участники «договариваются" (yielding): определяется кто уступает и получает временную боковую цель для обхода.
  2. Пост-проход: после интеграции позиций выполняется жёсткая коррекция наложений — мобильные слегка сдвигаются, чтобы устранить любые остаточные пересечения.
- Добавлен механизм, который раздает новую цель, если объект несколько раз подряд попадает в ситуацию потенциального столкновения (чтобы избежать петлей и «залипания").
- Скорость мобильных увеличена (по умолчанию в коде) — их ход стал более заметным; при желании значение легко изменить в одном месте.

## Stage 1 — первая фаза движения (реализовано)

Кратко:
- Длительность: примерно 20 секунд (реализовано как ограничение времени фазы, но анимация остаётся интерактивной после).
- Старт: движение начинается не ранее чем через 1 секунду после загрузки SVG.
- Кто движется: все 10 сопрано и все 10 альтов (остальные партии — статичны).
- Поведение: мобильные случайно, но равномерно рассредотачиваются по центральной области между колоннами. У каждого периодически меняется цель. При возможных конфликтах используется механизм переговоров и боковых уклонений.

Технические параметры Stage 1 (где смотреть в коде):
- `movementStart` — ms до старта движений (значение по умолчанию 1000).
- `stageDur` — длительность фазы (ms).
- Начальная скорость мобильных задаётся в `createSinger(...).speed` (по умолчанию ~54..84 px/s в текущей версии).
- Параметры steering/damping/separation находятся в скрипте как константы рядом с функцией движения (`steeringAlpha`, `separation` множители, `damping`).

## Структура кода и контракт данных

Основные сущности и их свойства (JS-объекты, доступные через `window.CHO`):

- Каждый певец (singer) — объект с полями:
  - `id` — уникальный идентификатор,
  - `role` — одна из 'soprano'|'alto'|'tenor'|'baritone'|'soloist',
  - `movable` — булево, движется ли певец,
  - `cx`, `cy` — текущие координаты центра,
  - `angle` — текущий угол поворота (deg), поворачивает всю `<g>` группу,
  - `target` — {x,y} — текущая цель (если мобильный),
  - `speed` — базовая желаемая скорость (px/s),
  - `vx`, `vy` — текущая скорость (px/s),
  - `rxx`, `ryy` — визуальные радиусы эллипса,
  - `dom` — ссылки на DOM-элементы {g, ell, arrow}.

- Глобальный контроллер: `window.CHO` содержит:
  - `CHO.singers` — массив всех певцов,
  - `CHO.mobile` — массив мобильных певцов,
  - `CHO.static` — статичных певцов,
  - `CHO.pickRandomTarget(singer)` — утилита для выбора новой цели,
  - `CHO.setStage(stageNumber)` — заглушка (можно расширить для смены стадии).

Контракт: реализация сцен и стадий должна использовать объекты певцов и менять их `.target`, `.speed`, `.movable` и т.д. для достижения нужной хореографии.

## Как добавлять новые стадии (рецепт)

1. Решите, кто в новой стадии двигается и кто статичен.
2. Опишите поведение партий (область движения, правила выбора целей, тайминги, спец.манёвры).
3. В коде SVG (в <script>) добавьте обработчик в `CHO.setStage(stageNum)` или расширьте логику state-machine:
   - присвойте мобильность через `s.movable = true/false` при смене стадии;
   - для каждой мобильной группы задайте новые шаблоны target-логики (например, круги, линии, formation targets);
   - можно использовать вспомогательную функцию `assignTargetsToGroup(group, fn)` где `fn(singer)` возвращает цель;
   - учтите правила избегания — текущая система прогнозирования/переговоров будет работать и для новых стадий.

Пример (псевдо-код для Stage 2, записываемого в `CHO.setStage`):

- Stage 2: "Солисты образуют V-образные приходы"
  - Для всех сопрано: s.movable = true; цель = функция, вычисляющая позицию в V-образной расстановке по индексу;
  - Для альтов: частично перемещаем в боковые позиции;
  - Для всех мобильных: увеличить `timeToNextTarget` и при необходимости уменьшить `steeringAlpha` для более стройных перемещений.

Синтаксис (пример):

```js
CHO.setStage = function(n){
  if(n===2){
    CHO.mobile.forEach((s,i)=>{ s.movable=true; s.target = computeVTarget(i); s.timeToNextTarget = 6000; });
  }
}
```

## Настройка и отладка

- Откройте `carol-the-bells.svg` простым двойным кликом или через браузер (File → Open File).
- Откройте DevTools (F12) и найдите `window.CHO` в консоли — вы можете менять параметры в реальном времени:
  - `CHO.mobile[0].speed = 20` — уменьшить скорость первого мобильного;
  - `CHO.mobile.forEach(s=>s.target = {x:800,y:400});` — задать общую цель;
  - `CHO.pickRandomTarget(CHO.mobile[3])` — посмотреть, как выбирается цель.

- Для визуального дебага (рекомендуемая практика): временно в коде добавить рисование целей и зон avoidance (прямоугольники/кружки) и переключатель `CHO.debug = true`.

## Где менять параметры (файловая привязка)

Файл: `carol-the-bells.svg` — весь движок и генерация певцов находятся внутри единственного `<script>` в файле. Ключевые места для редактирования:
- `const movementStart = 1000` — время старта;
- `const stageDur = 20000` — длительность фазы;
- `createSinger(...)` — здесь задаётся базовая `speed` для мобильных;
- раздел `pickRandomTarget` — логика распределения целей по свободной области;
- раздел движения (`step`/`requestAnimationFrame`) — здесь `steeringAlpha`, `damping`, коэффициенты separation/dodge и post-pass для разрешения перекрытий.

## Рекомендации по улучшению и расширению

- Добавить UI-контролы внутри SVG (Play/Pause, Stage select) — их можно отрисовать как SVG-кнопки и привязать к `CHO.setStage`.
- Экспортировать траектории в JSON для воспроизведения/анализирования или для создания альтернативных визуализаций.
- Для более крупной хореографии можно вынести параметры партий в структурированный объект `scenarios` и загружать их динамически.

## Лицензия и авторство

Файл создан по техническому заданию заказчика (содержимое prompt и последующие уточнения). Можно свободно изменять для собственных нужд.

---

Если хотите, я могу сразу:
- добавить `CHO.debug` визуализацию (цели, радиусы avoidance),
- добавить внутри SVG кнопки Play/Pause и выбор стадии,
- или сгенерировать шаблон `Stage 2` в `carol-the-bells.svg` по вашему сценарию.

Скажите, что делаем дальше.  