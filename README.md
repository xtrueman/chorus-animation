carol-the-bells — README

## Краткое содержание

Это репозиторий с одним самодостаточным SVG-файлом `carol-the-bells.svg`, который визуализирует схему хора и реализует фазу хореографии Stage 1 — движение сопрано и альтов в центральной области сцены.

README служит двухцелевой задаче:
- подробно фиксирует исходное техническое задание (включая изначальную формулировку задачи),
- даёт компактную и расширяемую структуру для добавления следующих стадий хореографии, параметров и правил поведения, на основании которой можно заново (или программно) воссоздать / править SVG.

## Исходный (начальный) prompt

Ниже — исходное задание (скопировано из начального запроса). Это важная спецификация, она должна сохраняться как источник правды при изменениях.

"Ты — опытный фронтенд-разработчик, умеющий писать чистые SVG c встраиваемым JavaScript (без внешних библиотек).  
Нужно сгенерировать ОДИН самодостаточный SVG-файл, который:

1) рисует статическую схему хора на сцене;
2) поэтапно анимирует движение части хористов согласно описанным стадиям хореографии.

Важна не «физика», а визуально правдоподобное, аккуратное движение: без телепортаций, без пересечений фигур и с понятным направлением взгляда.

========================================
ОБЩИЕ ТРЕБОВАНИЯ
========================================

1. Сцена:
   - Размер: сцена 16:9, например viewBox 0 0 1600 900.
   - Фон: тёмный прямоугольник + светлая рамка.
   - Вверху по центру подпись: «К зрителю (передний край сцены)» — верх картинки это фронт сцены.

2. Певцы:
   - Каждый певец — горизонтальный овал с соотношением сторон 2:1 (например rx=40, ry=20).
   - Цвета партий:
     - сопрано — жёлтый,
     - альты — оранжевый,
     - тенора — зелёный,
     - баритоны — синий,
     - солист — красный, чуть крупнее.
   - У каждого овала есть короткая, достаточно толстая стрелка-направление:
     - начинается из центра овала,
     - немного выходит вперёд за контур,
     - поворачивается вместе с овалом и показывает направление взгляда/движения.

3. Количество и партии:
   - сопрано: 10 человек, ДВИГАЮТСЯ в анимации;
   - альты: 10 человек, ДВИГАЮТСЯ в анимации;
   - тенора: 8 человек, стоят, НЕ двигаются (статичные препятствия);
   - баритоны: 8 человек, стоят, НЕ двигаются (статичные препятствия);
   - 1 солист: красный, по центру, НЕ двигается.

4. Исходная расстановка:
   - Две симметричные вертикальные колонны слева и справа.
   - В каждой колонне — 9 рядов по вертикали, в каждом ряду по 2 человека (левый и правый столбец).
   - Левая колонна:
     - верхние 5 рядов (ближе к зрителю) — альты (10 подвижных),
     - нижние 4 ряда — баритоны (8 статичных).
   - Правая колонна:
     - верхние 5 рядов — сопрано (10 подвижных),
     - нижние 4 ряда — тенора (8 статичных).
   - Колонны:
     - стоят близко к левому и правому краям сцены,
     - и относительно близко друг к другу, чтобы между ними оставалось большое, но не «пустое» поле.
   - Солист:
     - один красный овал чуть крупнее,
     - стоит по центру сцены ближе к переднему краю,
     - под ним текст «Солист».

5. Расстояния между овалами (БЕЗ пересечений):
   - Пусть ширина овала W (например, 80), высота H (например, 40).
   - Вертикальный шаг между рядами по центрам:
     H + (2/3)·W.
   - Горизонтальный шаг между двумя певцами в одном ряду по центрам:
     W + (2/3)·W.
   - В исходной расстановке овалы НЕ должны пересекаться ни по горизонтали, ни по вертикали.

6. Техника реализации (кратко):
   - Внутри SVG один `<script>` с чистым JS, без внешних библиотек.
   - Все певцы создаются ПРОЦЕДУРНО в JS через одну универсальную функцию `createSinger(...)`  
     (никакого ручного копипаста десятков `<g>` в разметке).
   - Для каждого певца храни:
     - роль (soprano/alto/tenor/baritone/soloist),
     - флаг подвижности,
     - исходные координаты центра,
     - текущий угол поворота (для стрелки),
     - для подвижных — текущую цель движения.

========================================
ОБЩИЕ ПРАВИЛА АНИМАЦИИ
========================================

Эти правила должны соблюдаться на всех стадиях:

1. Кто двигается:
   - Двигаются только сопрано и альты.
   - Баритоны, тенора и солист остаются на месте и играют роль препятствий.

2. Начало движения:
   - Фаза 1 и любая следующая фаза могут начинаться не раньше чем через 1 секунду от начала SVG (например, movementStart = 1000 мс).
   - ДО начала движения:
     - нельзя менять координаты и transform у подвижных фигур,
     - статичная картинка и первое положение в анимации должны совпадать пиксель-в-пиксель,
     - категорически недопустим «рывок" / скачок / gap в момент старта.

3. Движение:
   - Подвижные певцы ходят по центральной области между колоннами:
     - по X: внутри промежутка между левыми и правыми колоннами (без влезания в сами колонны),
     - по Y: от верхних рядов до нижних, но не выходя за сцену.
   - Траектории:
     - не только вверх-вниз, но и по диагонали,
     - певцы регулярно меняют направление — не должны всё время идти по одной прямой.
     - разумная схема: у каждого есть «цель» (targetX, targetY), он идёт к ней, потом получает новую цель (через достижение цели или по таймауту).

4. Поворот корпуса:
   - Направление стрелки и овала должно соответствовать направлению движения/взгляда.
   - При смене направления угол должен меняться плавно, с ограниченной скоростью поворота (без мгновенного разворота на 180° за один кадр).

5. Столкновения и пересечения:
   - В анимации подвижные фигуры НЕ должны:
     - проходить сквозь статичных (баритоны, тенора, солист),
     - проходить сквозь других подвижных.
   - Разрешён «алгоритмический" подход:
     - избегание препятствий при планировании следующего шага,
     - отталкивание при сильном сближении,
     - переназначение целей, если двое «упёрлись" друг в друга.
   - Важно: зритель никогда не должен видеть пересечения эллипсов.

========================================
СТАДИИ ХОРЕОГРАФИИ
========================================

Ниже я буду описывать хореографию ПООЧЕРЁДНО по стадиям.  
Каждая стадия:
- имеет номер и примерную длительность,
- описывает, кто и как двигается в этот период,
- начинается после окончания предыдущей стадии (или с указанной временной метки).

Сделай код так, чтобы можно было легко:
- добавить новую стадию,
carol-the-bells — руководство к действию

Этот документ — полноценное руководство для инженера или модели, которой вы передаёте доработку анимации/хореографии в `carol-the-bells.svg`.

Документ разделён на две части:
- Часть 1 — Вводные (все исходные технические и визуальные требования, контракт данных и ключевые точки изменения кода).
- Часть 2 — Сценарий (по-шаговое описание хореографии: для каждой стадии указано, с какой секунды она начинается и сколько длится).

Часть 1 — Вводные (подробно)
----------------------------------------

1) Назначение проекта
- Один самодостаточный SVG-файл `carol-the-bells.svg` с встроенным JavaScript. Файл должен визуализировать сцену хора и поэтапно анимировать подвижных участников.

2) Общая сцена и визуальные правила
- Формат сцены: 16:9 (например viewBox="0 0 1600 900"). Фон тёмный, рамка светлая.
- Вверху по центру текст: «К зрителю (передний край сцены)» — верх изображения соответствует фронту сцены.
- Каждый певец — горизонтальный овал (примерно W=80, H=40; rx=40, ry=20) с белой стрелкой-направлением, которая выходит чуть за контур овала и поворачивается вместе с ним.

3) Роли, количество и мобильность
- soprano: 10 — movable = true
- alto: 10 — movable = true
- tenor: 8 — movable = false (статичные препятствия)
- baritone: 8 — movable = false (статичные препятствия)
- soloist: 1 — movable = false, находится в центре

4) Исходная расстановка
- Две симметричные вертикальные колонны слева и справа.
- В каждой колонне 9 рядов по вертикали; в каждом ряду — 2 позиции (лево/право).
- Левая колонна: верхние 5 рядов — альты (подвижные), нижние 4 ряда — баритоны (статичные).
- Правая колонна: верхние 5 рядов — сопрано (подвижные), нижние 4 ряда — тенора (статичные).
- Солист чуть крупнее обычного овала и расположен по центру ближе к переднему краю; под ним текст «Солист».

5) Расстояния и constraints
- Вертикальный шаг между рядами: H + (2/3)·W.
- Горизонтальный шаг между двумя певцами в одном ряду: W + (2/3)·W.
- Нельзя допускать визуального перекрытия овалов в любые моменты анимации.

6) Контракт данных и структура объекта певца (важно для модели)
- Каждый певец — JS-объект с минимум полями:
  - id (integer)
  - role (string): 'soprano'|'alto'|'tenor'|'baritone'|'soloist'
  - movable (bool)
  - cx, cy (numbers) — текущие координаты центра
  - homeX, homeY (numbers) — исходная позиция в колонне
  - angle (degrees)
  - target {x,y} (nullable)
  - speed, vx, vy
  - rxx, ryy
  - dom {g, ell, arrow}

- Глобальный контроллер: `window.CHO` должен экспонировать:
  - CHO.singers — все певцы
  - CHO.mobile — мобильные певцы
  - CHO.static — статичные певцы
  - CHO.pickRandomTarget(singer) — утилита
  - CHO.setStage(n) — переключать стадии (расширяемо)

7) Поведение движения (алгоритмические требования)
- Подвижные части (soprano/alto) имеют модель движения: у каждого есть цель (target), они направляются к ней с ограничением скорости и плавным изменением угла (steeringAlpha, maxTurn).
- Избегание столкновений:
  - прогнозирование и мягкая договорённость (yielding), чтобы избежать пересечений;
  - пост-проход — жёсткая корректировка перекрытий;
  - если несколько подряд столкновений — смена цели.
- Все эти механики уже реализованы в текущем `carol-the-bells.svg`. Модель должна уважать и использовать эти механики при добавлении новых стадий.

8) Ключевые константы в коде (куда смотреть/править)
- movementStart = 1000 (ms) — задержка перед началом движения
- WALK_SPEED_MULT = 1.5 — текущий множитель скорости для подвижных
- PAIR_SELECT_AT, PAIR_SPLIT_AT, PAIR_WALK_END, PAIR_FACE_END, RETURN_END — константы временных меток в ms
- steeringAlpha, damping и т.д. — в разделе движения `step()`

9) Отладка и быстрая проверка
- Откройте `carol-the-bells.svg` в браузере и откройте DevTools.
- В консоли можно инспектировать `window.CHO` и корректировать поведение в реальном времени.
- Для визуальной отладки рекомендуется временно включать `CHO.debug` (цели, зоны avoidance) и/или рисовать маркеры home-слотов.

Часть 2 — Сценарий (пошагово, с точными таймингами)
---------------------------------------------------

Все времена ниже — в секундах, отсчитываемых от загрузки SVG (в коде константы заданы в мс). movementStart = 1s (1000 ms).

Stage A — Ожидание / готовность
- Начало: 0.0s
- Длительность: до 1.0s
- Описание: Статичное состояние. Всё размещено в исходных позициях. Нельзя менять координаты мобильных до movementStart.

Stage 1 — Свободное блуждание (Wander)
- Начало: 1.0s
- Длительность: до 20.0s (то есть 19s длительности, но в коде поведение продолжается интерактивно)
- Описание: Все сопрано и альты начинают движение в центральной области. Первые 3 секунды после старта цели тянут к центру (нельзя уходить от центра). Далее у каждого мобильного регулярно обновляется цель (target) — по достижении цели или по таймауту. Механизмы избегания столкновений активны.
- Внутри этой стадии:
  - Время 15.0s — коммерческий момент: каждый мобильный вычисляет ближайшего соседа и помечает `suggestedPartnerId` (5-секундное окно выбора).

Stage 2 — Формирование пар и парная ходьба
- Начало: 20.0s
- Длительность: 15.0s (20.0s–35.0s)
- Описание: Пары фиксируются greedy-алгоритмом с учётом коридоров между статикой. Пока пара не сблизилась — ослабленный коллизон, принудительное face-to-face и ориентация на партнёра. При встрече пары чередуют mode: 'face' / 'side' (face — лицом друг к другу, side — бок о бок с минимальным зазором ≈2px). Между центрами пар рисуется тонкая голубая линия (stroke #6ec8ff, width 2) на всём промежутке 20–45s.

Stage 3 — Остановка и разворот к зрителю
- Начало: 35.0s
- Длительность: 10.0s (35.0s–45.0s)
- Описание: Все пары останавливаются. Каждой паре назначается случайный `facingAngle` в диапазоне ±20°; оба участника пары плавно поворачиваются на этот угол и держат позицию.

Stage 4 — Возврат в колонны (реставрация формирования)
- Начало: 45.0s
- Длительность: 10.0s (45.0s–55.0s)
- Описание: Каждый мобильный заранее выбирает одно место своей стороны (альты — левая колонна, сопрано — правая) с приоритетом внешних позиций, затем внутренних, выбирая ближайшее к себе. Коллизии в этой стадии игнорируются. Скорость каждого подстраивается на каждом кадре так, чтобы гарантированно успеть вернуться в течение 10 секунд от старта стадии; по прибытии участник фиксируется на месте и смотрит строго вперёд.

Stage 5 — Формирование буквы X
- Начало: 55.0s (после восстановления колонн)
- Длительность: 16.0s
- Описание: Участвуют все ряды, включая статичных и солиста. Фаза 1 (первые 1.0s): шахматный разъезд по Y — левая колонна сдвигается вперёд на 1/4 шага ряда, правая назад на 1/4 шага; передний ряд не смещается; солист дополнительно выдвигается вперёд (≈1.5 шага ряда). Фаза 2 (следующие 15.0s): ряды смещаются по X, формируя букву X: для каждого ряда X-линия интерполируется от левой к правой колонне пропорционально глубине, с сохранением левого/правого места в ряду; Y остаётся со сдвигом фазы 1. Скорость одинакова в рамках каждой фазы (вычисляется из максимальной дистанции, чтобы все уложились в 1s/15s соответственно); передний ряд остаётся на месте. Коллизии отключены, все смотрят вперёд.

Stage 5 — Формирование буквы X
- Начало: 55.0s (после восстановления колонн)
- Длительность: 16.0s
- Описание: В первые 1.0s левая колонна смещается вперёд, правая — назад на половину шага между рядами для шахматного разъезда. Далее 15.0s ряды смещаются по горизонтали, формируя букву X: самый дальний ряд уходит на противоположный край, передние ряды остаются, промежуточные смещаются пропорционально. Итог — шахматный порядок по вертикали и горизонтали, визуально читаемая буква X.

Расширяемость: добавлять новые стадии
- Новая стадия — это просто объект с полями: {name, startSec, durationSec, behaviorFn}
- Добавлять стадию нужно в хронологическом порядке. Рекомендуемый паттерн: расширить `CHO.setStage(n)` и/или добавить state-machine на основе `startTime`.

Контрольные проверки (checklist для модели/инженера в процессе разработки)
1. Точки времени: 1s, 15s, 20s, 35s, 45s, 50s — убедитесь, что поведение и видимость артефактов соответствуют описанию.
2. Нет пересечений овалов в любой момент времени.
3. Пары визуально выделены голубой линией между центрами в промежутке 20–45s.
4. Повороты в 35s происходят с рандомным отклонением ±20° на пару и одинаковы для обеих фигур пары.
5. Возврат в 45s стартует через 10s после остановки и длится ~5s, структура колонн восстанавливается.

Полезные команды в DevTools (быстрая проверка):
- `CHO.mobile.length` — количество мобильных
- `CHO.singers.filter(s=>s.partnerId)` — кто помечен партнёром
- `CHO.pairs` — список пар (посмотреть `line` и `facingAngle`)
- `CHO.mobile.forEach(s=>s.target = {x:800,y:450})` — принудительно задать общую цель

Дополнительные улучшения (опционально)
- Плавный easing при возврате в колонны (ease-in-out);
- Маркеры home-слотов во время назначения (визуально полезно для демонстрации);
- Опции стиля линии (добавить dashed, уменьшить opacity) и включение линии также в окне выбора партнёров (15–20s).

Лицензия и авторство
- Содержимое создано по техническому заданию. Можно менять и адаптировать.

---

Если нужно, могу: добавить eased-переход при возвращении, поменять стиль парных линий или визуализировать home-слоты — скажите, что делаем дальше.
